pipeline {
    agent any
    
    stages {
        stage('Start Oracle') {
            steps {
                sh '''
                    echo "Oracle container başlatılıyor..."
                    
                    # docker-compose.oracle.yml oluştur
                    cat > docker-compose.oracle.yml << 'EOF'
services:
  oracle:
    image: gvenzl/oracle-xe:21-slim
    container_name: oracle-testdb
    environment:
      - ORACLE_PASSWORD=admin
      - ORACLE_DATABASE=testdb
    ports:
      - "1521:1521"
    healthcheck:
      test: ["CMD-SHELL", "sqlplus -L admin/admin@localhost:1521/XE <<< 'SELECT 1 FROM DUAL;'"]
      interval: 10s
      timeout: 5s
      retries: 30
    volumes:
      - oracle_data:/opt/oracle/oradata

volumes:
  oracle_data:
EOF
                    
                    docker compose -f docker-compose.oracle.yml up -d oracle
                    sleep 60
                    echo "Oracle hazır!"
                '''
            }
        }
        
        stage('Run Liquibase') {
            steps {
                sh '''
                    echo "Liquibase migration çalıştırılıyor..."
                    
                    # Liquibase container'ında her şeyi oluştur ve çalıştır
                    docker run --rm --network liquibase_default --user root \
                        liquibase/liquibase:4.25.1 \
                        sh -c "
                        # Oracle driver'ı indir
                        curl -L https://repo1.maven.org/maven2/com/oracle/database/jdbc/ojdbc11/21.9.0.0/ojdbc11-21.9.0.0.jar -o /liquibase/lib/ojdbc11-21.9.0.0.jar
                        
                        # Changelog dosyasını oluştur
                        mkdir -p /liquibase/changelog
                        cat > /liquibase/changelog/changelog.sql << 'CHANGELOG_EOF'
--liquibase formatted sql

--changeset admin:001:create-users-table context:ddl
CREATE TABLE users (
    id NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    username VARCHAR2(50) NOT NULL UNIQUE,
    email VARCHAR2(100) NOT NULL UNIQUE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
--rollback DROP TABLE users;

--changeset admin:002:create-categories-table context:ddl
CREATE TABLE categories (
    id NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    name VARCHAR2(50) NOT NULL UNIQUE,
    description CLOB,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
--rollback DROP TABLE categories;

--changeset admin:003:create-products-table context:ddl
CREATE TABLE products (
    id NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    name VARCHAR2(100) NOT NULL,
    description CLOB,
    price NUMBER(10,2) NOT NULL,
    category_id NUMBER,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    CONSTRAINT fk_products_category FOREIGN KEY (category_id) REFERENCES categories(id)
);
--rollback DROP TABLE products;

--changeset admin:010:seed-categories context:dml
INSERT INTO categories (name, description) VALUES 
('Electronics', 'Electronic devices');
INSERT INTO categories (name, description) VALUES 
('Clothing', 'Fashion items');
INSERT INTO categories (name, description) VALUES 
('Books', 'Books and literature');
--rollback DELETE FROM categories WHERE name IN ('Electronics', 'Clothing', 'Books');

--changeset admin:011:seed-users context:dml
INSERT INTO users (username, email) VALUES 
('admin', 'admin@example.com');
INSERT INTO users (username, email) VALUES 
('user1', 'user1@example.com');
--rollback DELETE FROM users WHERE username IN ('admin', 'user1');

--changeset admin:012:seed-products context:dml
INSERT INTO products (name, description, price, category_id) VALUES 
('Laptop', 'High-performance laptop', 999.99, 1);
INSERT INTO products (name, description, price, category_id) VALUES 
('T-Shirt', 'Cotton t-shirt', 19.99, 2);
INSERT INTO products (name, description, price, category_id) VALUES 
('Programming Book', 'Learn programming', 49.99, 3);
--rollback DELETE FROM products WHERE name IN ('Laptop', 'T-Shirt', 'Programming Book');
CHANGELOG_EOF
                        
                        # Liquibase çalıştır
                        liquibase --url='jdbc:oracle:thin:@oracle:1521:XE' \
                        --username=admin \
                        --password=admin \
                        --driver=oracle.jdbc.OracleDriver \
                        --classpath=/liquibase/lib \
                        --changeLogFile=changelog/changelog.sql \
                        update
                        "
                    
                    echo "Migration tamamlandı!"
                '''
            }
        }
        
        stage('Show Database Structure') {
            steps {
                sh '''
                    echo "=== VERİTABANI YAPISI ==="
                    echo "Tablolar:"
                    docker compose -f docker-compose.oracle.yml exec -T oracle sqlplus -L admin/admin@localhost:1521/XE <<< "SELECT TABLE_NAME FROM USER_TABLES"
                    
                    echo ""
                    echo "=== USERS TABLOSU ==="
                    docker compose -f docker-compose.oracle.yml exec -T oracle sqlplus -L admin/admin@localhost:1521/XE <<< "SELECT COLUMN_NAME, DATA_TYPE FROM USER_TAB_COLUMNS WHERE TABLE_NAME = 'USERS'"
                    docker compose -f docker-compose.oracle.yml exec -T oracle sqlplus -L admin/admin@localhost:1521/XE <<< "SELECT * FROM users"
                    
                    echo ""
                    echo "=== CATEGORIES TABLOSU ==="
                    docker compose -f docker-compose.oracle.yml exec -T oracle sqlplus -L admin/admin@localhost:1521/XE <<< "SELECT COLUMN_NAME, DATA_TYPE FROM USER_TAB_COLUMNS WHERE TABLE_NAME = 'CATEGORIES'"
                    docker compose -f docker-compose.oracle.yml exec -T oracle sqlplus -L admin/admin@localhost:1521/XE <<< "SELECT * FROM categories"
                    
                    echo ""
                    echo "=== PRODUCTS TABLOSU ==="
                    docker compose -f docker-compose.oracle.yml exec -T oracle sqlplus -L admin/admin@localhost:1521/XE <<< "SELECT COLUMN_NAME, DATA_TYPE FROM USER_TAB_COLUMNS WHERE TABLE_NAME = 'PRODUCTS'"
                    docker compose -f docker-compose.oracle.yml exec -T oracle sqlplus -L admin/admin@localhost:1521/XE <<< "SELECT * FROM products"
                '''
            }
        }
    }
    
    post {
        always {
            sh '''
                echo "Cleanup yapılıyor..."
                docker compose -f docker-compose.oracle.yml down
            '''
        }
        success {
            echo "Oracle migration başarıyla tamamlandı!"
        }
        failure {
            echo "Oracle migration başarısız!"
        }
    }
}
